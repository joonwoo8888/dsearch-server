name: Docker Image CI
# 마스터 푸시, 풀 리퀘스트 이벤트 발생하면 아래 잡들을 실행함.
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
# 빌드 잡 정의시작.
  build:
#   실행 플랫폼은 ubuntu사용, runs: windows, mac os, ubuntu 있음.
    runs-on: ubuntu-latest
    steps:
#     소스코드 checkout
    - uses: actions/checkout@v2
#     JDK 활성화
    - name: Setup Java JDK
      uses: actions/setup-java@v2.5.0
      with:
        java-version: 8.0.312+7
        distribution: adopt
#     java maven 캐시 불러움
    - name: Maven Cache
      uses: skjolber/maven-cache-github-action@v1.1
      with:
         step: restore

#     Maven 빌드
    - name: Spring Boot Build with Maven
      run: mvn package -Dskip.test=true

#     java maven 캐시 저장
    - name: Maven Cache
      uses: skjolber/maven-cache-github-action@v1.1
      with:
         step: save


#     pom.xml 버전을 추출합니다.
    - name: extract version for pom.xml
      run: echo "VERSION=$(grep -oPm2 "(?<=<version>)[^<]+" pom.xml | sed -n 2p)" >> $GITHUB_ENV
#     도커 이미지 빌드
    - name: Build Docker image
      run: docker build . --file Dockerfile --tag "$GITHUB_REPOSITORY:${{ env.VERSION }}"
    - name: ghcr.io login
      run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u joonwoo8888 --password-stdin
    - name: publish Docker image
      run: docker push $GITHUB_REPOSITORY:${{ env.VERSION }}
      

      
      
        
        

    
    
    
        

